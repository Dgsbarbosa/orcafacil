{% load currency %}
{% load static %}

{% block extra_css %}
<style>

  /* ===== RESET PARA XHTML2PDF ===== */
  /* Ele cria bordas automáticas → zeramos todas */
  table, th, td {
      border: none !important;
  }

  /* Remove bordas involuntárias no container */
  .view-print {
      border: none !important;
      padding: 20px;
      font-family: Helvetica, Arial, sans-serif;
      font-size: 12px;
      color: #000;
  }

  .company-header {
      text-align: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border: none !important;
  }

  .company-header h1 {
      font-size: 18px;
      margin: 0;
      padding: 0;
  }

  /* Caixa de seção */
  .section-title {
      background: #eee;
      border: 1px solid #000 !important;
      padding: 6px;
      font-weight: bold;
      margin-top: 22px;
      margin-bottom: 5px;
  }

  /* Tabelas principais */
  table.print-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 5px;
  }

  /* Agora aplicamos borda SOMENTE onde queremos */
  table.print-table th,
  table.print-table td {
      border: 1px solid #000 !important;
      padding: 5px;
      vertical-align: top;
  }

  table.print-table th {
      background: #f2f2f2;
  }

  .footer {
      margin-top: 30px;
      text-align: center;
      font-size: 11px;
      border-top: 1px solid #000 !important;
      padding-top: 10px;
  }

</style>
{% endblock %}


<div class="container view-print" id="area-pdf">

  <!-- ========================= CABEÇALHO ========================= -->
  <div class="company-header">
      <h1>Novo Padrão Reforma e Manutenção Predial</h1>
      <div>DOUGLAS ALEXANDRE BARBOSA 36813601890</div>
      <div>CNPJ: 37.763.872/0001-11 - CEP: 17033-810</div>
      <div>E-mail: novopadrao.reformas@gmail.com</div>
      <div>Telefone: (14) 99734-9757 / (14) 99198-0130</div>
  </div>

  <!-- ========================= TÍTULO ========================= -->
  <h2 style="text-align:center; margin-top:5px;">Orçamento {{ budget.code }}</h2>


  <!-- ========================= CLIENTE ========================= -->
  <div class="section-title">Dados do Cliente</div>

  <p><strong>Nome:</strong> {{ budget.client.name }} {{ budget.client.lastname }}</p>
  <p><strong>Telefone:</strong> {{ budget.client.phone }}</p>
  <p><strong>Email:</strong> {{ budget.client.email }}</p>


  <!-- ========================= INFORMAÇÕES DO ORÇAMENTO ========================= -->
  <div class="section-title">Informações</div>
  <p><strong>Título:</strong> {{ budget.title }}</p>
  <p><strong>Status:</strong> {{ budget.get_status_display }}</p>
  <p><strong>Data:</strong> {{ budget.created_at|date:"d/m/Y" }}</p>


  <!-- ========================= SERVIÇOS ========================= -->
  <div class="section-title">Serviços</div>

  <table class="print-table">
      <tr>
          <th>Serviço</th>
          <th>Descrição</th>
          <th>Qtd</th>
          <th>Preço Unitário</th>
          <th>Subtotal</th>
      </tr>

      {% for s in services %}
      <tr>
          <td>{{ s.service }}</td>
          <td>{{ s.description }}</td>
          <td>{% if s.quantity %}{{ s.quantity }}{% endif %}</td>
          <td>{{ s.unit_price|currency }}</td>
          <td>{{ s.subtotal_budget|currency }}</td>
      </tr>
      {% endfor %}
  </table>


  <!-- ========================= MATERIAIS ========================= -->
  <div class="section-title">Materiais</div>

  <table class="print-table">
      <tr>
          <th>Material</th>
          <th>Descrição</th>
          <th>Qtd</th>
          <th>Preço Unitário</th>
          <th>Subtotal</th>
      </tr>

      {% for m in materials %}
      <tr>
          <td>{{ m.name }}</td>
          <td>{{ m.description }}</td>
          <td>{% if m.quantity %}{{ m.quantity }}{% endif %}</td>
          <td>{{ m.unit_price|currency }}</td>
          <td>{{ m.subtotal_material|currency }}</td>
      </tr>
      {% endfor %}
  </table>


  <!-- ========================= VALOR TOTAL ========================= -->
  <div class="section-title">Total Geral</div>
  <p style="font-size: 15px; font-weight: bold;">
    R$ {{ budget.total_value }}
  </p>


  <!-- ========================= OBSERVAÇÕES ========================= -->
  {% if budget.obs %}
  <div class="section-title">Observações</div>
  <p>{{ budget.obs }}</p>
  {% endif %}


  <!-- ========================= RODAPÉ ========================= -->
  <div class="footer">
    Facebook: novopadrao.reformas • Instagram: @novopadrao.reformas  
    <br>
    Obrigado pela confiança!  
  </div>

</div>

<button id="btnDownloadPdf" class="btn btn-primary">Baixar PDF</button>
{% block js_extra%}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
<script>

document.getElementById("btnDownloadPdf").addEventListener("click", () => {

    const element = document.getElementById("area-pdf");

    const options = {
        margin:       5,
        filename:     "orcamento-{{ budget.code }}.pdf",
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  {
            scale: 2,            // aumenta nitidez
            useCORS: true
        },
        jsPDF:        {
            unit: 'mm',
            format: 'a4',
            orientation: 'portrait'
        }
    };

    html2pdf().set(options).from(element).save();
});

</script>

{% endblock %}